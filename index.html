<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ¬ Her ÅŸeyi Ä°ndir</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4">

  <div class="bg-gray-800 p-6 rounded-xl shadow-lg w-full max-w-md">
    <h1 class="text-3xl font-bold text-center text-green-400 mb-6">ğŸ¬ www.herseyindir.com </h1>


    <input id="ngrok" placeholder="Ngrok baÄŸlantÄ±sÄ±" class="w-full p-2 mb-4 rounded bg-gray-700 text-white" />
    <input id="videoUrl" placeholder="Video URL" class="w-full p-2 mb-4 rounded bg-gray-700 text-white" />

    <div class="flex space-x-2 mb-4">
      <button onclick="indirVideo()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded">MP4 Ä°ndir</button>
      <button onclick="getFormats()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded">MP3 Ä°ndir</button>
    </div>

    <div id="formatlar" class="space-y-2"></div>
    <div id="durum" class="mt-4 text-sm text-center"></div>
  </div>

  <script>
    async function indirVideo() {
      const ngrok = document.getElementById("ngrok").value;
      const url = document.getElementById("videoUrl").value;
      const durum = document.getElementById("durum");
      durum.textContent = "ğŸï¸ Video formatÄ± hazÄ±rlanÄ±yor...";
      await fetch(`${ngrok}/indir`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url })
      });
      durum.textContent = "â¬‡ï¸ Video indiriliyor...";
      setTimeout(() => {
        durum.textContent = "âœ… Video indirildi.";
      }, 3000);
    }

    async function getFormats() {
      const ngrok = document.getElementById("ngrok").value;
      const url = document.getElementById("videoUrl").value;
      const formatlar = document.getElementById("formatlar");
      const durum = document.getElementById("durum");

      formatlar.innerHTML = "";
      durum.textContent = "ğŸµ Formatlar aranÄ±yor...";

      const res = await fetch(`${ngrok}/ses-formatlari`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url })
      });

      const data = await res.json();
      if (!data.formats) {
        durum.textContent = "âŒ Ses formatÄ± bulunamadÄ±.";
        return;
      }

      durum.textContent = "ğŸ§ MP3 formatÄ± seÃ§in:";
      data.formats.forEach(f => {
        const btn = document.createElement("button");
        btn.className = "block w-full bg-blue-500 hover:bg-blue-600 py-2 rounded text-white font-semibold";
        btn.textContent = f.abr ? `${f.abr} kbps` : "Bilinmeyen kalite";
        btn.onclick = () => indirMP3(f.format_id, f.title);
        formatlar.appendChild(btn);
      });
    }

    async function indirMP3(format_id, title) {
      const ngrok = document.getElementById("ngrok").value;
      const url = document.getElementById("videoUrl").value;
      const durum = document.getElementById("durum");
      const formatlar = document.getElementById("formatlar");

      durum.textContent = "ğŸ¶ MP3'e dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lÃ¼yor...";

      const response = await fetch(`${ngrok}/indir-mp3`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url, format_id, title })
      });

      if (!response.ok) {
        durum.textContent = "âŒ Ä°ndirme baÅŸarÄ±sÄ±z.";
        return;
      }

      const blob = await response.blob();
      const blobUrl = window.URL.createObjectURL(blob);

      // Dosya adÄ±nÄ± baÅŸlÄ±kla oluÅŸtur (uygunsuz karakterler temizleniyor)
      const safeTitle = title.replace(/[\\/:*?"<>|]/g, "").trim();
      const fileName = `${safeTitle}.mp3`;

      const a = document.createElement("a");
      a.href = blobUrl;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(blobUrl);

      durum.textContent = "âœ… MÃ¼zik baÅŸarÄ±yla indirildi.";
      formatlar.innerHTML = "";
    }
  </script>
</body>
</html>
