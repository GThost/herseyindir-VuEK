<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ¬ Her Åeyi Ä°ndir!</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>body{font-family:'Inter',sans-serif}</style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4">
  <div class="bg-gray-800 p-8 rounded-xl shadow-lg w-full max-w-md">
    <h1 class="text-3xl font-bold text-center text-green-400 mb-6">ğŸ¬ HerÅŸeyi Ä°ndir</h1>

    <div class="mb-4">
      <label for="videoUrl" class="block text-sm font-medium text-gray-400 mb-1">Video URL'si</label>
      <input id="videoUrl" type="text" placeholder="https://youtu.be/..." class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400"/>
    </div>

    <div class="flex gap-4 mb-4">
      <button id="mp4button" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition transform hover:scale-105">
        ğŸ¬ Mp4 Video Ä°ndir
      </button>
      <button id="mp3button" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition transform hover:scale-105">
        ğŸµ Mp3 MÃ¼zik Ä°ndir
      </button>
    </div>

    <div id="formatlar" class="space-y-2"></div>
    <div id="durum" class="mt-4 text-center font-semibold text-sm"></div>
  </div>

<script>
const BASE_URL = "https://YOUR-APP.railway.app"; // <-- kendi domainin

// Mobil/youtube kÄ±saltmalarÄ±nÄ± kanonik watch?v=ID ÅŸekline Ã§evir
function normalizeYouTubeUrl(u){
  try{
    const url = new URL(u.trim());
    if (url.hostname.includes("youtu.be")) {
      const id = url.pathname.replace(/^\/+/, "");
      return "https://www.youtube.com/watch?v=" + id;
    }
    const p = url.pathname;
    const q = url.searchParams;
    if (p.startsWith("/shorts/") || p.startsWith("/embed/") || p.startsWith("/live/")){
      const id = p.split("/")[2] || p.split("/")[1];
      return "https://www.youtube.com/watch?v=" + id;
    }
    if (q.get("v")) return "https://www.youtube.com/watch?v=" + q.get("v");
    return u.trim();
  } catch { return u.trim(); }
}

function downloadBlob(blob, filename){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename || "";
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 1500);
}

const durum = msg => {
  const el = document.getElementById("durum");
  el.textContent = msg || "";
  el.className = "mt-4 text-center font-semibold text-sm " + (msg.startsWith("âŒ") ? "text-red-400" : msg.startsWith("âœ…") ? "text-green-400" : "");
};

async function indirMP4(){
  const btn = document.getElementById("mp4button");
  const raw = document.getElementById("videoUrl").value;
  const url = normalizeYouTubeUrl(raw);
  if (!url) { durum("â— LÃ¼tfen geÃ§erli bir URL girin."); return; }

  btn.disabled = true; btn.textContent = "Ä°ndiriliyor...";
  durum("â³ Video indiriliyor...");
  try{
    const r = await fetch(`${BASE_URL}/indir`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ url })
    });
    if(!r.ok) throw new Error(await r.text());
    const blob = await r.blob();
    downloadBlob(blob, "video.mp4");
    durum("âœ… Video indirildi.");
  }catch(e){ durum("âŒ MP4 hata: " + e.message); }
  finally{ btn.disabled = false; btn.textContent = "ğŸ¬ Mp4 Video Ä°ndir"; }
}

async function getFormats(){
  const raw = document.getElementById("videoUrl").value;
  const url = normalizeYouTubeUrl(raw);
  const listEl = document.getElementById("formatlar");
  listEl.innerHTML = "";
  durum("ğŸµ Formatlar aranÄ±yor...");

  try{
    const r = await fetch(`${BASE_URL}/ses-formatlari`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ url })
    });
    if(!r.ok) throw new Error(await r.text());
    const data = await r.json();
    const formats = (data.formats||[]).filter(f=>f.abr).sort((a,b)=>(b.abr||0)-(a.abr||0));

    if(!formats.length){ durum("âŒ Ses formatÄ± bulunamadÄ±."); return; }
    durum("ğŸ§ MP3 bitrate seÃ§in:");

    formats.forEach(f=>{
      const b = document.createElement("button");
      b.className = "block w-full bg-blue-500 hover:bg-blue-600 py-2 rounded text-white font-semibold";
      b.textContent = `${f.abr||"?"} kbps`;
      b.onclick = () => indirMP3(url, f.format_id, f.title || "audio");
      listEl.appendChild(b);
    });
  }catch(e){ durum("âŒ Format hatasÄ±: " + e.message); }
}

async function indirMP3(url, formatId, title){
  durum("ğŸ¶ MP3'e dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lÃ¼yor...");
  try{
    const r = await fetch(`${BASE_URL}/indir-mp3`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ url, format_id: String(formatId), title })
    });
    if(!r.ok) throw new Error(await r.text());
    const blob = await r.blob();
    const safeTitle = (title||"audio").replace(/[\\/:*?"<>|]/g,"").trim() || "audio";
    downloadBlob(blob, safeTitle+".mp3");
    document.getElementById("formatlar").innerHTML = "";
    durum("âœ… MÃ¼zik indirildi.");
  }catch(e){ durum("âŒ MP3 hata: " + e.message); }
}

// buton baÄŸla
document.getElementById("mp4button").addEventListener("click", indirMP4);
document.getElementById("mp3button").addEventListener("click", getFormats);
</script>
</body>
</html>
